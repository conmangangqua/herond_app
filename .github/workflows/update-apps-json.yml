name: Update apps.json on release

on:
  release:
    types: [published, released]
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag (leave empty to use latest release)'
        required: false
        type: string

permissions:
  contents: write

jobs:
  update-apps-json:
    runs-on: ubuntu-latest

    steps:
      # ===================== CHECKOUT =====================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Checkout default branch
        run: |
          DEFAULT_BRANCH=$(git symbolic-ref refs/remotes/origin/HEAD | sed 's@^refs/remotes/origin/@@' || echo "main")
          git checkout $DEFAULT_BRANCH || git checkout main || git checkout master

      # ===================== SETUP TOOLS =====================
      - name: Setup jq and GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl
          if ! command -v gh &> /dev/null; then
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt-get update
            sudo apt-get install gh -y
          fi
          gh --version
          echo "GitHub CLI installed successfully"

      # ===================== EXTRACT RELEASE INFO =====================
      - name: Extract release info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          EVENT_NAME="${{ github.event_name }}"
          echo "Event name: $EVENT_NAME"
          echo "REPO=${{ github.repository }}" >> $GITHUB_ENV
          
          if [ "$EVENT_NAME" = "release" ]; then
            # Trigger từ release event
            echo "Using release event data"
            echo "TAG=${{ github.event.release.tag_name }}" >> $GITHUB_ENV
            echo "RELEASE_NAME=${{ github.event.release.name }}" >> $GITHUB_ENV
          else
            # Trigger từ workflow_dispatch (chạy thủ công)
            RELEASE_TAG="${{ inputs.release_tag }}"
            if [ -n "$RELEASE_TAG" ] && [ "$RELEASE_TAG" != "" ]; then
              echo "Fetching specific release: $RELEASE_TAG"
              RELEASE_DATA=$(gh api repos/${{ github.repository }}/releases/tags/$RELEASE_TAG --jq '{tag_name: .tag_name, name: .name}')
            else
              echo "Fetching latest release via API"
              RELEASE_DATA=$(gh api repos/${{ github.repository }}/releases/latest --jq '{tag_name: .tag_name, name: .name}')
            fi
            
            echo "Release data: $RELEASE_DATA"
            TAG_NAME=$(echo "$RELEASE_DATA" | jq -r '.tag_name // empty')
            RELEASE_NAME=$(echo "$RELEASE_DATA" | jq -r '.name // empty')
            echo "TAG=$TAG_NAME" >> $GITHUB_ENV
            echo "RELEASE_NAME=$RELEASE_NAME" >> $GITHUB_ENV
            echo "Extracted TAG: $TAG_NAME, RELEASE_NAME: $RELEASE_NAME"
          fi

      # ===================== PARSE RELEASE ASSETS =====================
      - name: Parse release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          EVENT_NAME="${{ github.event_name }}"
          
          if [ "$EVENT_NAME" = "release" ]; then
            # Trigger từ release event - dùng data từ event
            echo "Using release event assets"
            ASSETS='${{ toJson(github.event.release.assets) }}'
            echo "$ASSETS" > /tmp/all_assets.json
          else
            # Trigger từ workflow_dispatch - tổng hợp từ tất cả releases (dev, prod, aab)
            echo "Fetching assets from all releases (dev, prod, aab)..."
            
            # Fetch và save từng release assets vào temp files
            echo "Fetching from 'dev' release..."
            gh api repos/${{ github.repository }}/releases/tags/dev --jq '.assets // []' > /tmp/dev_assets.json 2>/dev/null || echo "[]" > /tmp/dev_assets.json
            
            echo "Fetching from 'prod' release..."
            gh api repos/${{ github.repository }}/releases/tags/prod --jq '.assets // []' > /tmp/prod_assets.json 2>/dev/null || echo "[]" > /tmp/prod_assets.json
            
            echo "Fetching from 'aab' release..."
            gh api repos/${{ github.repository }}/releases/tags/aab --jq '.assets // []' > /tmp/aab_assets.json 2>/dev/null || echo "[]" > /tmp/aab_assets.json
            
            # Combine all assets using jq -s (slurp mode)
            ALL_ASSETS=$(jq -s 'flatten | unique_by(.id)' /tmp/dev_assets.json /tmp/prod_assets.json /tmp/aab_assets.json)
            echo "$ALL_ASSETS" > /tmp/all_assets.json
            echo "Combined assets count: $(echo "$ALL_ASSETS" | jq 'length')"
          fi

      # ===================== BUILD apps.json =====================
      - name: Build apps.json from scratch
        run: |
          python3 << 'PYTHON_SCRIPT'
          import json
          import sys
          
          # Read all assets
          with open('/tmp/all_assets.json', 'r') as f:
              all_assets = json.load(f)
          
          # Extract all app IDs from file names
          app_ids = set()
          for asset in all_assets:
              name = asset.get('name', '')
              if name.endswith('_dev.apk'):
                  app_ids.add(name.replace('_dev.apk', ''))
              elif name.endswith('_prod.apk'):
                  app_ids.add(name.replace('_prod.apk', ''))
              elif name.endswith('.aab'):
                  app_ids.add(name.replace('.aab', ''))
              elif name.endswith('_icon.png'):
                  app_ids.add(name.replace('_icon.png', ''))
          
          app_ids = sorted(list(app_ids))
          print(f"Found app IDs: {', '.join(app_ids)}")
          
          # Build apps array
          apps = []
          for app_id in app_ids:
              # Find URLs for this app
              dev_url = ""
              prod_url = ""
              aab_url = ""
              icon_url = ""
              
              for asset in all_assets:
                  name = asset.get('name', '')
                  url = asset.get('browser_download_url', '')
                  
                  if name == f"{app_id}_dev.apk":
                      dev_url = url
                  elif name == f"{app_id}_prod.apk":
                      prod_url = url
                  elif name == f"{app_id}.aab":
                      aab_url = url
                  elif name == f"{app_id}_icon.png":
                      icon_url = url
              
              # Format app name (video_downloader -> Video Downloader)
              app_name = ' '.join(word.capitalize() for word in app_id.replace('_', ' ').split())
              
              print(f"Processing app: {app_id}")
              print(f"  DEV: {dev_url or 'none'}")
              print(f"  PROD: {prod_url or 'none'}")
              print(f"  AAB: {aab_url or 'none'}")
              print(f"  ICON: {icon_url or 'none'}")
              
              # Build downloads dict (only include non-empty values)
              downloads = {}
              if dev_url:
                  downloads['dev'] = dev_url
              if prod_url:
                  downloads['prod'] = prod_url
              if aab_url:
                  downloads['aab'] = aab_url
              
              app = {
                  'id': app_id,
                  'name': app_name,
                  'icon': icon_url,
                  'platform': 'Android',
                  'description': '',
                  'features': [],
                  'downloads': downloads
              }
              apps.append(app)
          
          # Create final JSON
          result = {'apps': apps}
          
          # Write to file
          with open('apps.json', 'w') as f:
              json.dump(result, f, indent=2)
          
          print(f"\nCreated new apps.json with {len(apps)} apps")
          print("apps.json content:")
          print(json.dumps(result, indent=2))
          PYTHON_SCRIPT

      # ===================== COMMIT & PUSH =====================
      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          echo "Git status before add:"
          git status
          
          git add apps.json

          echo "Git status after add:"
          git status
          
          echo "Git diff --cached:"
          git diff --cached || true

          if git diff --cached --quiet; then
            echo "No changes to commit"
            echo "Checking if apps.json changed:"
            git diff apps.json || echo "No diff in apps.json"
            exit 0
          fi

          git commit -m "chore: update apps.json for ${TAG:-latest release}"
          git push
